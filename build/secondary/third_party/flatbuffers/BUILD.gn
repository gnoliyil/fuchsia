# Copyright 2017 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import("//third_party/flatbuffers/flatbuffer.gni")

config("flatbuffers_warnings") {
  cflags = [
    "-Wno-conversion",
    "-Wno-implicit-fallthrough",
    "-Wno-extra-semi",
  ]
}

config("flatbuffers_config") {
  include_dirs = [ "src/include" ]
}

source_set("flatbuffers") {
  sources = [
    "src/include/flatbuffers/flatbuffers.h",
    "src/include/flatbuffers/hash.h",
  ]

  configs += [ ":flatbuffers_warnings" ]
  public_configs = [
    ":flatbuffers_config",

    # TODO(fxbug.dev/78646) Remove this config after std::iterator usages are cleaned up.
    "//build/config:suppress_iterator_warnings",
  ]

  # TODO(46773): UBSan has found an instance of undefined behavior in this target.
  # Disable UBSan for this target temporarily until it is migrated into CI/CQ.
  public_configs += [ "//build/config:temporarily_disable_ubsan_do_not_use" ]
}

source_set("compiler_files") {
  sources = [
    "src/grpc/src/compiler/cpp_generator.cc",
    "src/grpc/src/compiler/cpp_generator.h",
    "src/grpc/src/compiler/go_generator.cc",
    "src/grpc/src/compiler/go_generator.h",
    "src/grpc/src/compiler/schema_interface.h",
    "src/include/flatbuffers/code_generators.h",
    "src/include/flatbuffers/idl.h",
    "src/include/flatbuffers/util.h",
    "src/src/idl_gen_cpp.cpp",
    "src/src/idl_gen_fbs.cpp",
    "src/src/idl_gen_general.cpp",
    "src/src/idl_gen_go.cpp",
    "src/src/idl_gen_grpc.cpp",
    "src/src/idl_gen_js.cpp",
    "src/src/idl_gen_php.cpp",
    "src/src/idl_gen_python.cpp",
    "src/src/idl_gen_text.cpp",
    "src/src/idl_parser.cpp",
    "src/src/reflection.cpp",
    "src/src/util.cpp",
  ]
  include_dirs = [ "src/grpc" ]
  visibility = [ ":*" ]
  deps = [ ":flatbuffers" ]
  configs += [ ":flatbuffers_warnings" ]
}

executable("flatc") {
  sources = [ "src/src/flatc.cpp" ]
  deps = [
    ":compiler_files",
    ":flatbuffers",
  ]

  if (is_linux) {
    libs = [ "pthread" ]
  }
}
