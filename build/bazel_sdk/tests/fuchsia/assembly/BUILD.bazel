# Copyright 2022 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load(":fuchsia_product_configuration_test.bzl", "fuchsia_product_configuration_test")
load(":fuchsia_images_configuration_test.bzl", "fuchsia_images_configuration_test")
load(":fuchsia_partitions_configuration_test.bzl", "fuchsia_partitions_configuration_test")
load(":fuchsia_virtual_device_test.bzl", "fuchsia_virtual_device_test")
load(
    "@fuchsia_sdk//fuchsia:assembly.bzl",
    "BLOBFS_LAYOUT",
    "PARTITION_TYPE",
    "SLOT",
    "ZBI_COMPRESSION",
    "fuchsia_assemble_package",
    "fuchsia_bootloader_partition",
    "fuchsia_bootstrap_partition",
    "fuchsia_filesystem_blobfs",
    "fuchsia_filesystem_empty_account",
    "fuchsia_filesystem_empty_data",
    "fuchsia_filesystem_reserved",
    "fuchsia_fvm_nand",
    "fuchsia_fvm_sparse",
    "fuchsia_fvm_standard",
    "fuchsia_images_configuration",
    "fuchsia_partition",
    "fuchsia_partitions_configuration",
    "fuchsia_prebuilt_package",
    "fuchsia_product_configuration",
    "fuchsia_vbmeta",
    "fuchsia_virtual_device",
    "fuchsia_zbi",
)

fuchsia_prebuilt_package(
    name = "prebuilt_ams_light",
    archive = ":test_data/ams-light-test-0.far",
)

fuchsia_prebuilt_package(
    name = "prebuilt_driver",
    archive = ":test_data/backlight_driver.far",
    drivers = [
        "meta/backlight_driver.cm",
    ],
)

fuchsia_assemble_package(
    name = "assembled_ams_light",
    configs = {
        ":test_data/config_data.json": "config_data.json",
    },
    package = ":prebuilt_ams_light",
)

# buildifier: leave-alone
fuchsia_product_configuration(
    name = "testing_product_config",

    # Product configuration items
    base_packages = [
        ":assembled_ams_light",
    ],
    cache_packages = [
        ":prebuilt_ams_light",
    ],
    driver_packages = [
        ":prebuilt_driver",
    ],
    json_config = {
        "platform": {
            "build_type": "user",
            "additional_serial_log_tags": [
                "session-manager",
                "session:session",
            ],
            "connectivity": {"wlan": {
                "legacy_privacy_support": True,
            }},
            "development_support": {"enabled": True},
            "diagnostics": {
                "archivist": "default",
                "additional_serial_log_components": [
                    "/core/session-manager",
                    "/core/session-manager/session:session",
                ],
            },
            "identity": {"password_pinweaver": "required"},
            "input": {"supported_input_devices": [
                "button",
                "keyboard",
            ]},
            "some": {"random": {
                "path1": True,
                "int1": 3234234324231434134141234,
                "string1": "I have a string",
            }},
            "another": {"random": {
                "path1": False,
                "int": 0,
                "string2": "false",
            }},
        },
        "product": {
            "session_url": "fuchsia-pkg://fuchsia.com/tiles-session#meta/tiles-session.cm",
        },
    },
)

fuchsia_product_configuration_test(
    name = "product_config_golden_test",
    # Unfortunately, the golden file contains paths that depend on the target
    # build configuration (e.g. x86_64-fastbuild/... for x64 builds, and
    # aarch64-fastbuild/... for arm64 ones), so different golden files need
    # to be provided.
    golden_file = select({
        "@fuchsia_sdk//fuchsia/constraints:cpu_arm64": ":test_data/product_config_golden_file_arm64.json",
        "@fuchsia_sdk//fuchsia/constraints:cpu_x64": ":test_data/product_config_golden_file_x64.json",
    }),
    product_config = ":testing_product_config",
    visibility = ["//visibility:public"],
)

fuchsia_product_configuration(
    name = "testing_product_config_with_labels",
    json_config = {
        "platform": {
            "foo": "LABEL(test_data/foo.txt)",
        },
        "product": {
            "bar": "LABEL(test_data/bar.txt)",
        },
    },
)

fuchsia_product_configuration_test(
    name = "product_config_with_labels_golden_test",
    golden_file = ":test_data/product_config_with_labels_golden_file.json",
    product_config = ":testing_product_config_with_labels",
    visibility = ["//visibility:public"],
)

fuchsia_zbi(
    name = "my_zbi",
    compression = ZBI_COMPRESSION.ZSTD_MAX,
    postprocessing_args = [
        "-v",
    ],
    postprocessing_script = ":test_data/execute_script.sh",
    zbi_name = "fuchsia",
)

fuchsia_vbmeta(
    name = "my_vbmeta",
    key = ":test_data/local_key_file",
    key_metadata = ":test_data/local_key_metadata_file",
    vbmeta_name = "fuchsia",
)

fuchsia_filesystem_blobfs(
    name = "my_blobfs",
    compress = True,
    layout = BLOBFS_LAYOUT.DEPRECATED_PADDED,
    maximum_contents_size = "182452224",
)

fuchsia_filesystem_empty_data(
    name = "my_empty_data",
)

fuchsia_filesystem_reserved(
    name = "my_reserved",
    slices = "32",
)

fuchsia_filesystem_empty_account(
    name = "my_empty_account",
)

fuchsia_fvm_standard(
    name = "fvm_standard",
    compress = True,
    filesystems = [
        ":my_blobfs",
        ":my_empty_account",
        ":my_empty_data",
        ":my_reserved",
    ],
    fvm_standard_name = "fvm",
)

fuchsia_fvm_standard(
    name = "fvm_standard_no_account",
    compress = True,
    filesystems = [
        ":my_blobfs",
        ":my_empty_data",
        ":my_reserved",
    ],
    fvm_standard_name = "fvm",
    resize_image_file_to_fit = True,
    truncate_to_length = "17179869184",
)

fuchsia_fvm_sparse(
    name = "fvm_sparse",
    filesystems = [
        ":my_blobfs",
        ":my_empty_data",
        ":my_reserved",
    ],
    fvm_sparse_name = "fvm.sparse",
    max_disk_size = "410779648",
)

fuchsia_fvm_nand(
    name = "fvm_nand",
    block_count = "1564",
    compress = True,
    filesystems = [
        ":my_blobfs",
        ":my_empty_data",
        ":my_reserved",
    ],
    fvm_nand_name = "fvm.nand",
    max_disk_size = "410779648",
    oob_size = "8",
    page_size = "4096",
    pages_per_block = "64",
)

fuchsia_images_configuration(
    name = "my_images_configuration",
    fvm_slice_size = "32768",
    images = [
        ":my_zbi",
        ":my_vbmeta",
        ":fvm_nand",
        ":fvm_standard",
        ":fvm_sparse",
    ],
)

fuchsia_images_configuration(
    name = "my_images_configuration_no_vbmeta_no_account",
    images = [
        ":my_zbi",
        ":fvm_nand",
        ":fvm_standard_no_account",
        ":fvm_sparse",
    ],
)

fuchsia_images_configuration_test(
    name = "images_config_golden_test",
    golden_file = ":test_data/images_config_golden_file.json",
    images_config = ":my_images_configuration",
    visibility = ["//visibility:public"],
)

fuchsia_images_configuration_test(
    name = "images_config_no_vbmeta_no_account_golden_test",
    golden_file = ":test_data/images_config_golden_file_no_vbmeta.json",
    images_config = ":my_images_configuration_no_vbmeta_no_account",
    visibility = ["//visibility:public"],
)

fuchsia_bootstrap_partition(
    name = "bootstrap_partition_3728",
    condition_value = "0xe9000000",
    condition_variable = "emmc-total-bytes",
    image = ":test_data/gpt.fuchsia.3728.bin",
    partition_name = "gpt",
)

fuchsia_bootstrap_partition(
    name = "bootstrap_partition_3776",
    condition_value = "0xe9000000",
    condition_variable = "emmc-total-bytes",
    image = ":test_data/gpt.fuchsia.3776.bin",
    partition_name = "gpt",
)

fuchsia_bootloader_partition(
    name = "my_bootloader_partition",
    image = ":test_data/u-boot.bin.signed.test-b4",
    partition_name = "bootloader",
    type = "skip_metadata",
)

fuchsia_partition(
    name = "zbi_partition",
    partition_name = "zircon_a",
    slot = SLOT.A,
    type = PARTITION_TYPE.ZBI,
)

fuchsia_partition(
    name = "vbmeta_partition",
    partition_name = "vbmeta_b",
    slot = SLOT.B,
    type = PARTITION_TYPE.VBMETA,
)

fuchsia_partition(
    name = "fvm_partition",
    partition_name = "fvm",
    type = PARTITION_TYPE.FVM,
)

fuchsia_partitions_configuration(
    name = "my_partitions_config",
    bootloader_partitions = [
        ":my_bootloader_partition",
    ],
    bootstrap_partitions = [
        ":bootstrap_partition_3776",
        ":bootstrap_partition_3728",
    ],
    hardware_revision = "workstation",
    partitions = [
        ":zbi_partition",
        ":vbmeta_partition",
        ":fvm_partition",
    ],
    unlock_credentials = [
        ":test_data/unlock-creds.zip",
    ],
)

fuchsia_partitions_configuration_test(
    name = "partitions_config_golden_test",
    golden_file = ":test_data/partitions_config_golden_file.json",
    partitions_config = ":my_partitions_config",
    visibility = ["//visibility:public"],
)

fuchsia_virtual_device(
    name = "my_virtual_device",
    arch = "x64",
    device_name = "test",
    memory_quantity = 16,
    memory_unit = "gigabytes",
    storage_quantity = 8,
    storage_unit = "terabytes",
    window_height_px = 2160,
    window_width_px = 3840,
)

fuchsia_virtual_device_test(
    name = "virtual_device_golden_test",
    golden_file = ":test_data/virtual_device_golden_file.json",
    virtual_device = ":my_virtual_device",
    visibility = ["//visibility:public"],
)
