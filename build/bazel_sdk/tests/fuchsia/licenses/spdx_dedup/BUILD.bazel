# Copyright 2022 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load(
    "@fuchsia_sdk//fuchsia:licenses.bzl",
    "fuchsia_licenses_spdx",
)
load("@rules_license//rules:license.bzl", "license")
load("@bazel_skylib//rules:diff_test.bzl", "diff_test")

license(
    name = "license",
    package_name = "license foo",
    license_text = "license_1.txt",
)

license(
    name = "license_different_name_and_text",
    package_name = "license bar",
    license_text = "license_2.txt",
)

license(
    name = "license_different_name_same_text",
    package_name = "license bar",
    license_text = "license_1_copy.txt",
)

license(
    name = "license_same_name_different_text",
    package_name = "license foo",
    license_text = "license_2.txt",
)

license(
    name = "license_same_name_and_text",
    package_name = "license foo",
    license_text = "license_1_copy.txt",
)

genrule(
    name = "target_with_licenses",
    outs = ["out.txt"],
    applicable_licenses = [
        ":license",
        ":license_different_name_and_text",
        ":license_different_name_same_text",
        ":license_same_name_different_text",
        ":license_same_name_and_text",
    ],
    cmd = "echo \"hello\" > \"$@\"",
)

fuchsia_licenses_spdx(
    name = "actual_licenses.spdx.json",
    document_namespace = "some_namespace",
    licenses_cross_refs_base_url = "https://fuchsia.googlesource.com/sdk-integration/tests/",
    target = ":target_with_licenses",
)

diff_test(
    name = "golden_test",
    file1 = ":actual_licenses.spdx.json",
    # Copied from third_party/sdk-integration/tests/bazel-bin/fuchsia/licenses/spdx_dedup/actual_licenses.spdx.json
    file2 = "expected_licenses.spdx.json",
)
