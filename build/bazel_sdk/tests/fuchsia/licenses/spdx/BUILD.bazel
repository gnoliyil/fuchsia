# Copyright 2022 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

load(
    "@fuchsia_sdk//fuchsia:defs.bzl",
    "fuchsia_component",
    "fuchsia_component_manifest",
    "fuchsia_package",
)
load(
    "@fuchsia_sdk//fuchsia:licenses.bzl",
    "fuchsia_licenses_spdx",
)
load("@rules_license//rules:license.bzl", "license")
load("@bazel_skylib//rules:diff_test.bzl", "diff_test")

package(
    default_applicable_licenses = [":default_license"],
)

license(
    name = "default_license",
    package_name = "Package with default license",
    copyright_notice = "Test Copyright",
    license_kinds = [],
    license_text = "default_license.txt",
    package_url = "http://foo.bar",
)

license(
    name = "component_a_license",
    package_name = "Component A",
    license_kinds = [],
    license_text = "license_a.txt",
)

license(
    name = "component_b_license",
    package_name = "Component B",
    license_kinds = [],
    license_text = "license_b.spdx.json",
)

fuchsia_component_manifest(
    name = "component_a_manifest",
    component_name = "component_a",
    content = "{}",
)

fuchsia_component_manifest(
    name = "component_b_manifest",
    component_name = "component_b",
    content = "{}",
)

fuchsia_component(
    name = "component_a",
    applicable_licenses = [":component_a_license"],
    manifest = ":component_a_manifest",
)

fuchsia_component(
    name = "component_b",
    applicable_licenses = [":component_b_license"],
    manifest = ":component_b_manifest",
)

fuchsia_package(
    name = "test_package",
    components = [
        ":component_a",
        ":component_b",
    ],
)

fuchsia_licenses_spdx(
    name = "actual_licenses.spdx.json",
    document_namespace = "https://fuchsia.googlesource.com/sdk-integration/tests/fuchsia/licenses/spdx",
    licenses_cross_refs_base_url = "https://fuchsia.googlesource.com/sdk-integration/tests/",
    root_package_name = "my_root_package",
    target = ":test_package",
)

diff_test(
    name = "golden_test",
    file1 = "expected_licenses.spdx.json",
    # Copied from third_party/sdk-integration/tests/bazel-bin/fuchsia/licenses/spdx/actual_licenses.spdx.json
    file2 = ":actual_licenses.spdx.json",
    visibility = ["//visibility:public"],
)
